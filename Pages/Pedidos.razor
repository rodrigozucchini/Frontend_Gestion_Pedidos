@page "/pedidos"
@using System.Net.Http.Json
@inject HttpClient Http
@inject IJSRuntime JS

<div class="mb-3">
    <NavLink class="btn btn-secondary me-2" href="/">Volver al Home</NavLink>
</div>

<h3>Gestión de Pedidos</h3>

<div class="mb-3">
    <button class="btn btn-warning me-2" @onclick="ModoActualizacion">Actualizaciones de Pedidos</button>
    <button class="btn btn-info me-2" @onclick="ModoListar">Listar Pedidos</button>
    <NavLink class="btn btn-warning me-2" href="/pedidos/agregar">Agregar pedidos</NavLink>
</div>

@if (vistaActual == "actualizacion")
{
    @if (pedidos is null)
    {
        <p>No hay pedidos cargados.</p>
    }
    else if (!pedidos.Any())
    {
        <p>No se encontraron pedidos.</p>
    }
    else
    {
        <div style="overflow-x: auto;">
            <table class="table table-striped table-sm" style="white-space: nowrap; margin-bottom: 0;">
                <thead>
                    <tr style="font-size: 0.85rem;">
                        <th style="padding: 0.4rem;">N° Pedido</th>
                        <th style="padding: 0.4rem;">Cliente</th>
                        <th style="padding: 0.4rem;">Email</th>
                        <th style="padding: 0.4rem;">Estado</th>
                        <th style="padding: 0.4rem;">Fecha</th>
                        <th style="padding: 0.4rem;">Total</th>
                        <th style="padding: 0.4rem;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var p in pedidos)
                    {
                        <tr style="font-size: 0.85rem;">
                            <td style="padding: 0.4rem;">@p.NumeroPedido</td>
                            <td style="padding: 0.4rem;">@p.NombreCliente</td>
                            <td style="padding: 0.4rem;">@p.EmailCliente</td>
                            <td style="padding: 0.4rem;">
                                @if (pedidoEnEdicion == p.NumeroPedido)
                                {
                                    <select class="form-select form-select-sm" style="padding: 0.25rem; font-size: 0.8rem;" @bind="estadoTemporal">
                                        <option value="Pendiente">Pendiente</option>
                                        <option value="Cancelado">Cancelado</option>
                                        <option value="Completado">Completado</option>
                                    </select>
                                }
                                else
                                {
                                    @p.Estado
                                }
                            </td>
                            <td style="padding: 0.4rem;">@p.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
                            <td style="padding: 0.4rem;">@p.Total</td>
                            <td style="padding: 0.4rem;">
                                @if (pedidoEnEdicion == p.NumeroPedido)
                                {
                                    <button class="btn btn-success btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" @onclick="() => GuardarEstado(p)">Guardar</button>
                                    <button class="btn btn-secondary btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" @onclick="CancelarEdicion">Cancelar</button>
                                }
                                else
                                {
                                    <button class="btn btn-primary btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin-right: 0.4rem;" @onclick="() => ModificarCabecera(p)">Modificar</button>

                                    @if (p.Estado.Equals("Pendiente", StringComparison.OrdinalIgnoreCase))
                                    {
                                        <button class="btn btn-secondary btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin-right: 0.4rem;" @onclick="() => MostrarDetalles(p.NumeroPedido)">Detalles</button>
                                    }
                                    else
                                    {
                                        <button class="btn btn-secondary btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; opacity:0.6; cursor:not-allowed; margin-right: 0.4rem;" disabled>Detalles</button>
                                    }

                                    <button class="btn btn-danger btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin-right: 0.4rem;" @onclick="() => ConfirmarEliminarCabecera(p.NumeroPedido)">Eliminar</button>

                                    <input type="number" class="form-control form-control-sm" style="padding: 0.25rem; font-size: 0.8rem; width: 70px; display: inline-block; margin-right: 0.4rem;" min="1"
                                           placeholder="N° det"
                                           @bind="numeroDetalleEliminarPorPedido[p.NumeroPedido]" />
                                    <button class="btn btn-outline-danger btn-sm"
                                            style="padding: 0.25rem 0.5rem; font-size: 0.75rem; white-space: nowrap;"
                                            @onclick="() => ConfirmarEliminarDetalle(p.NumeroPedido)">
                                        Eliminar Det
                                    </button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    @if (mostrarFormularioDetalle && detallePedido.Any())
    {
        <div class="mt-4">
            <h4>Detalles del pedido @numeroPedidoSeleccionado</h4>
            <div style="overflow-x: auto;">
                <table class="table table-bordered table-sm" style="white-space: nowrap; margin-bottom: 0;">
                    <thead>
                        <tr style="font-size: 0.85rem;">
                            <th style="padding: 0.4rem;">N° Detalle</th>
                            <th style="padding: 0.4rem;">Producto</th>
                            <th style="padding: 0.4rem;">Cantidad</th>
                            <th style="padding: 0.4rem;">Precio Unitario</th>
                            <th style="padding: 0.4rem;">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var d in detallePedido)
                        {
                            <tr style="font-size: 0.85rem;">
                                <td style="padding: 0.4rem;">@d.NumeroDetalle</td>
                                <td style="padding: 0.4rem;">@d.Producto</td>
                                <td style="padding: 0.4rem;">
                                    <input type="number" class="form-control form-control-sm" style="padding: 0.25rem; font-size: 0.8rem; width: 70px;" min="1"
                                           @bind="d.Cantidad" @bind:event="oninput"
                                           @onchange="(_) => RecalcularSubtotal(d)" />
                                </td>
                                <td style="padding: 0.4rem;">@d.PrecioUnitario.ToString("0.00")</td>
                                <td style="padding: 0.4rem;">@d.Subtotal.ToString("0.00")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <button class="btn btn-success btn-sm mt-2" style="padding: 0.5rem 1rem; font-size: 0.9rem;" @onclick="GuardarCambiosDetalle">Guardar cambios</button>

            <div class="mt-3 p-2 border rounded" style="background-color: #f8f9fa;">
                <h6 style="font-size: 0.9rem; margin-bottom: 0.5rem;">Agregar nuevo detalle</h6>
                <div style="display: flex; gap: 0.4rem; align-items: center; flex-wrap: wrap;">
                    <select class="form-select form-select-sm" style="padding: 0.25rem; font-size: 0.8rem; flex: 0 1 300px; max-width: 100%;" @bind="productoSeleccionadoNuevo">
                        <option value="0">Seleccione un producto</option>
                        @foreach (var p in productos)
                        {
                            var yaSeleccionado = detallePedido.Any(d => d.Producto == p.Nombre);
                            <option value="@p.Id" disabled="@yaSeleccionado">
                                @p.Nombre - $@p.Precio
                                @(yaSeleccionado ? " (ya existe)" : "")
                            </option>
                        }
                    </select>
                    <input type="number" class="form-control form-control-sm" style="padding: 0.25rem; font-size: 0.8rem; width: 80px;"
                           min="1" max="1000" @bind="cantidadNueva" placeholder="Cantidad" />
                    <button class="btn btn-info btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; white-space: nowrap;"
                            @onclick="AgregarNuevoDetalle">
                        Agregar Detalle
                    </button>
                </div>
            </div>

            <button class="btn btn-secondary btn-sm mt-2" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" @onclick="CerrarDetalles">Cerrar</button>
        </div>
    }
}
else if (vistaActual == "listar")
{
    @if (pedidosListar is null)
    {
        <p>No hay pedidos cargados.</p>
    }
    else if (!pedidosListar.Any())
    {
        <p>No se encontraron pedidos.</p>
    }
    else
    {
        <div style="overflow-x: auto;">
            <table class="table table-striped table-sm" style="white-space: nowrap; margin-bottom: 0;">
                <thead>
                    <tr style="font-size: 0.85rem;">
                        <th style="padding: 0.4rem;">N° Pedido</th>
                        <th style="padding: 0.4rem;">Cliente</th>
                        <th style="padding: 0.4rem;">Email</th>
                        <th style="padding: 0.4rem;">Estado</th>
                        <th style="padding: 0.4rem;">Fecha</th>
                        <th style="padding: 0.4rem;">Total</th>
                        <th style="padding: 0.4rem;">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var p in pedidosListar)
                    {
                        <tr style="font-size: 0.85rem;">
                            <td style="padding: 0.4rem;">@p.NumeroPedido</td>
                            <td style="padding: 0.4rem;">@p.NombreCliente</td>
                            <td style="padding: 0.4rem;">@p.EmailCliente</td>
                            <td style="padding: 0.4rem;">@p.Estado</td>
                            <td style="padding: 0.4rem;">@p.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
                            <td style="padding: 0.4rem;">@p.Total</td>
                            <td style="padding: 0.4rem;">
                                <button class="btn btn-secondary btn-sm" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; margin-right: 0.4rem;" @onclick="() => MostrarDetallesListar(p.NumeroPedido)">Ver Detalles</button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    }

    @if (mostrarFormularioDetalleListar && detalleListar.Any())
    {
        <div class="mt-4">
            <h4 style="font-size: 1rem;">Detalles del pedido @numeroPedidoListarSeleccionado</h4>
            <div style="overflow-x: auto;">
                <table class="table table-bordered table-sm" style="white-space: nowrap; margin-bottom: 0;">
                    <thead>
                        <tr style="font-size: 0.85rem;">
                            <th style="padding: 0.4rem;">N° Detalle</th>
                            <th style="padding: 0.4rem;">Producto</th>
                            <th style="padding: 0.4rem;">Cantidad</th>
                            <th style="padding: 0.4rem;">Precio Unitario</th>
                            <th style="padding: 0.4rem;">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var d in detalleListar)
                        {
                            <tr style="font-size: 0.85rem;">
                                <td style="padding: 0.4rem;">@d.NumeroDetalle</td>
                                <td style="padding: 0.4rem;">@d.Producto</td>
                                <td style="padding: 0.4rem;">@d.Cantidad</td>
                                <td style="padding: 0.4rem;">@d.PrecioUnitario.ToString("0.00")</td>
                                <td style="padding: 0.4rem;">@d.Subtotal.ToString("0.00")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <button class="btn btn-secondary btn-sm mt-2" style="padding: 0.25rem 0.5rem; font-size: 0.75rem;" @onclick="CerrarDetallesListar">Cerrar</button>
        </div>
    }
}

@code {
    // Vista Actualización
    private List<PedidoCabecera> pedidos = new();
    private List<DetallePedido> detallePedido = new();
    private List<Producto> productos = new();
    private bool mostrarFormularioDetalle = false;
    private string numeroPedidoSeleccionado = string.Empty;
    private Dictionary<string, int> numeroDetalleEliminarPorPedido = new();
    private string pedidoEnEdicion = string.Empty;
    private string estadoTemporal = string.Empty;
    private int productoSeleccionadoNuevo = 0;
    private int cantidadNueva = 1;

    // Vista Listar
    private List<PedidoCabecera> pedidosListar = new();
    private List<DetallePedido> detalleListar = new();
    private bool mostrarFormularioDetalleListar = false;
    private string numeroPedidoListarSeleccionado = string.Empty;

    // Control de vista
    private string vistaActual = "";

    // --- Cambiar a modo actualización ---
    private async Task ModoActualizacion()
    {
        vistaActual = "actualizacion";
        await CargarPedidos();
    }

    // --- Cambiar a modo listar ---
    private async Task ModoListar()
    {
        vistaActual = "listar";
        await CargarPedidosListar();
    }

    // --- Cargar pedidos para actualización ---
    private async Task CargarPedidos()
    {
        try
        {
            pedidos = await Http.GetFromJsonAsync<List<PedidoCabecera>>("pedidos/cabeceras") ?? new();
            numeroDetalleEliminarPorPedido = pedidos.ToDictionary(p => p.NumeroPedido, p => 0);
            await CargarProductos();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al cargar pedidos: {ex.Message}, la api no esta en funcionamiento");
        }
    }

    // --- Cargar pedidos para listar ---
    private async Task CargarPedidosListar()
    {
        try
        {
            pedidosListar = await Http.GetFromJsonAsync<List<PedidoCabecera>>("pedidos/cabeceras") ?? new();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al cargar pedidos: {ex.Message}, la api no esta en funcionamiento");
        }
    }

    // --- Cargar productos ---
    private async Task CargarProductos()
    {
        try
        {
            productos = await Http.GetFromJsonAsync<List<Producto>>("productos") ?? new();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al cargar productos: {ex.Message}, la API no esta en funcionamiento");
        }
    }

    // --- Modificar cabecera ---
    private void ModificarCabecera(PedidoCabecera pedido)
    {
        pedidoEnEdicion = pedido.NumeroPedido;
        estadoTemporal = pedido.Estado;
    }

    private void CancelarEdicion() => pedidoEnEdicion = string.Empty;

    private async Task GuardarEstado(PedidoCabecera pedido)
    {
        try
        {
            var body = new { estado = estadoTemporal };

            var response = await Http.PutAsJsonAsync($"pedidos/cabeceras/{pedido.NumeroPedido}", body);
            if (response.IsSuccessStatusCode)
            {
                pedido.Estado = estadoTemporal;
                pedidoEnEdicion = string.Empty;
                await JS.InvokeVoidAsync("alert", "Estado actualizado correctamente.");
                await CargarPedidos();
            }
            else
            {
                var msg = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Error al actualizar estado: {msg}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}, la API no esta en funcionamiento");
        }
    }

    // --- Mostrar detalles para edición ---
    private async Task MostrarDetalles(string numeroPedido)
    {
        numeroPedidoSeleccionado = numeroPedido;
        mostrarFormularioDetalle = true;

        try
        {
            detallePedido = await Http.GetFromJsonAsync<List<DetallePedido>>($"pedidos/{numeroPedido}/detalles") ?? new();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al obtener detalles: {ex.Message}, la API no esta en funcionamiento");
        }
    }

    // --- Mostrar detalles para listar (solo lectura) ---
    private async Task MostrarDetallesListar(string numeroPedido)
    {
        numeroPedidoListarSeleccionado = numeroPedido;
        mostrarFormularioDetalleListar = true;

        try
        {
            detalleListar = await Http.GetFromJsonAsync<List<DetallePedido>>($"pedidos/{numeroPedido}/detalles") ?? new();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al obtener detalles: {ex.Message}, la API no esta en funcionamiento");
        }
    }

    // --- Cerrar detalles ---
    private void CerrarDetalles()
    {
        mostrarFormularioDetalle = false;
        detallePedido.Clear();
    }

    // --- Cerrar detalles listar ---
    private void CerrarDetallesListar()
    {
        mostrarFormularioDetalleListar = false;
        detalleListar.Clear();
    }

    // --- Recalcular subtotal ---
    private async void RecalcularSubtotal(DetallePedido d)
    {
        if (d.Cantidad < 1)
        {
            d.Cantidad = 1;
            await JS.InvokeVoidAsync("alert", "La cantidad mínima es 1.");
        }
        else if (d.Cantidad > 1000)
        {
            d.Cantidad = 1000;
            await JS.InvokeVoidAsync("alert", "La cantidad máxima es 1000.");
        }

        d.Subtotal = d.Cantidad * d.PrecioUnitario;
    }

    // --- Guardar cambios de detalle ---
    private async Task GuardarCambiosDetalle()
    {
        try
        {
            foreach (var d in detallePedido)
            {
                if (d.Cantidad < 1)
                    d.Cantidad = 1;

                var dto = new { cantidad = d.Cantidad, precioUnitario = d.PrecioUnitario };
                await Http.PutAsJsonAsync($"pedidos/{numeroPedidoSeleccionado}/detalles/{d.NumeroDetalle}", dto);
            }

            var totalActualizado = detallePedido.Sum(x => x.Subtotal);

            var pedido = pedidos.FirstOrDefault(p => p.NumeroPedido == numeroPedidoSeleccionado);
            if (pedido != null)
                pedido.Total = totalActualizado;

            await JS.InvokeVoidAsync("alert", "Cambios guardados correctamente.");
            await MostrarDetalles(numeroPedidoSeleccionado);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al guardar cambios: {ex.Message}, la API no esta en funcionamiento");
        }
    }

    // --- Agregar nuevo detalle ---
    private async Task AgregarNuevoDetalle()
    {
        if (productoSeleccionadoNuevo == 0)
        {
            await JS.InvokeVoidAsync("alert", "Seleccione un producto.");
            return;
        }

        if (cantidadNueva < 1 || cantidadNueva > 1000)
        {
            await JS.InvokeVoidAsync("alert", "La cantidad debe ser entre 1 y 1000.");
            return;
        }

        try
        {
            var nuevoDetalle = new { productoId = productoSeleccionadoNuevo, cantidad = cantidadNueva };
            var response = await Http.PostAsJsonAsync($"pedidos/{numeroPedidoSeleccionado}/detalles/create", nuevoDetalle);

            if (response.IsSuccessStatusCode)
            {
                await JS.InvokeVoidAsync("alert", "Detalle agregado correctamente.");
                productoSeleccionadoNuevo = 0;
                cantidadNueva = 1;
                await MostrarDetalles(numeroPedidoSeleccionado);
                StateHasChanged();
            }
            else
            {
                var msg = await response.Content.ReadAsStringAsync();
                await JS.InvokeVoidAsync("alert", $"Error al agregar detalle: {msg}");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error: {ex.Message}, la API no esta en funcionamiento");
        }
    }

    // --- Eliminar cabecera ---
    private async Task ConfirmarEliminarCabecera(string numeroPedido)
    {
        if (await JS.InvokeAsync<bool>("confirm", $"¿Seguro que desea eliminar la cabecera {numeroPedido}?"))
        {
            await EliminarCabecera(numeroPedido);
        }
    }

    private async Task EliminarCabecera(string numeroPedido)
    {
        try
        {
            var response = await Http.DeleteAsync($"pedidos/cabeceras/{numeroPedido}");
            if (response.IsSuccessStatusCode)
            {
                pedidos.RemoveAll(p => p.NumeroPedido == numeroPedido);
                detallePedido.Clear();
                mostrarFormularioDetalle = false;
                await JS.InvokeVoidAsync("alert", "Cabecera eliminada correctamente.");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al eliminar cabecera: {ex.Message}, la API no esta en funcionamiento");
        }
    }

    // --- Eliminar detalle ---
    private async Task ConfirmarEliminarDetalle(string numeroPedido)
    {
        if (!numeroDetalleEliminarPorPedido.TryGetValue(numeroPedido, out var numeroDetalle) || numeroDetalle <= 0)
        {
            await JS.InvokeVoidAsync("alert", "Ingrese un número de detalle válido.");
            return;
        }

        if (!detallePedido.Any(d => d.NumeroDetalle == numeroDetalle))
        {
            await JS.InvokeVoidAsync("alert", $"El detalle {numeroDetalle} no existe en este pedido.");
            return;
        }

        if (await JS.InvokeAsync<bool>("confirm", $"¿Seguro que desea eliminar el detalle {numeroDetalle}?"))
        {
            await EliminarDetalle(numeroPedido, numeroDetalle);
            StateHasChanged();
        }
    }

    private async Task EliminarDetalle(string numeroPedido, int numeroDetalle)
    {
        try
        {
            var response = await Http.DeleteAsync($"pedidos/{numeroPedido}/detalles/{numeroDetalle}");
            if (response.IsSuccessStatusCode)
            {
                detallePedido.RemoveAll(d => d.NumeroDetalle == numeroDetalle);
                await CargarPedidos();
                await MostrarDetalles(numeroPedido);
                await JS.InvokeVoidAsync("alert", "Detalle eliminado correctamente.");
            }
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("alert", $"Error al eliminar detalle: {ex.Message}, la API no esta en funcionamiento");
        }
    }

    // --- Clases ---
    public class PedidoCabecera
    {
        public string NumeroPedido { get; set; } = string.Empty;
        public string NombreCliente { get; set; } = string.Empty;
        public string EmailCliente { get; set; } = string.Empty;
        public string Estado { get; set; } = string.Empty;
        public DateTime Fecha { get; set; }
        public decimal Total { get; set; }
    }

    public class DetallePedido
    {
        public int NumeroDetalle { get; set; }
        public string Producto { get; set; } = string.Empty;
        public int Cantidad { get; set; }
        public decimal PrecioUnitario { get; set; }
        public decimal Subtotal { get; set; }
    }

    public class Producto
    {
        public int Id { get; set; }
        public string Nombre { get; set; } = string.Empty;
        public decimal Precio { get; set; }
    }
}